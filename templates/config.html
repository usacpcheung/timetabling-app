<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Configuration</h1>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul id="flash-messages" class="flashes">
        {% for category, msg in messages %}
        <li class="{{ category }}">{{ msg }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}
    <form method="post">
        <fieldset>
            <legend>General</legend>
            <label>Slots per day: <input type="number" name="slots_per_day" value="{{ config['slots_per_day'] }}"></label><br>
            <label>Slot duration (minutes): <input type="number" name="slot_duration" value="{{ config['slot_duration'] }}"></label><br>
            <label>Lesson duration (minutes): <input type="number" name="lesson_duration" value="{{ config['lesson_duration'] }}"></label><br>
            <label>Min lessons per student: <input type="number" name="min_lessons" value="{{ config['min_lessons'] }}"></label><br>
            <label>Max lessons per student: <input type="number" name="max_lessons" value="{{ config['max_lessons'] }}"></label><br>
            <label>Min lessons per teacher: <input type="number" name="teacher_min_lessons" value="{{ config['teacher_min_lessons'] }}"></label><br>
            <label>Max lessons per teacher: <input type="number" name="teacher_max_lessons" value="{{ config['teacher_max_lessons'] }}"></label><br>
            <label>Allow repeated lessons?
                <input type="checkbox" name="allow_repeats" {% if config['allow_repeats'] %}checked{% endif %}>
            </label><br>
            <label>Allow different teachers per subject?
                <input type="checkbox" name="allow_multi_teacher" {% if config['allow_multi_teacher'] %}checked{% endif %}>
            </label><br>
            <label>Max repeats per teacher/subject:
                <input type="number" name="max_repeats" value="{{ config['max_repeats'] }}" min="1">
            </label><br>
            <label>Allow consecutive repeat slots?
                <input type="checkbox" name="allow_consecutive" {% if config['allow_consecutive'] %}checked{% endif %}>
            </label><br>
            <label>Prefer consecutive repeats?
                <input type="checkbox" name="prefer_consecutive" {% if config['prefer_consecutive'] %}checked{% endif %}>
            </label><br>
            <label>Consecutive preference weight:
                <input type="number" name="consecutive_weight" value="{{ config['consecutive_weight'] }}" min="1">
            </label><br>
            <label>Require all subjects?
                <input type="checkbox" name="require_all_subjects" {% if config['require_all_subjects'] %}checked{% endif %}>
            </label><br>
            <label>Use attendance priority?
                <input type="checkbox" name="use_attendance_priority" {% if config['use_attendance_priority'] %}checked{% endif %}>
            </label><br>
            <label>Attendance weight:
                <input type="number" name="attendance_weight" value="{{ config['attendance_weight'] }}" min="1">
            </label>
            <label>Group weight:
                <input type="number" name="group_weight" value="{{ config['group_weight'] }}" min="1" step="0.1">
            </label>
            <label>Balance teacher load?
                <input type="checkbox" name="balance_teacher_load" {% if config['balance_teacher_load'] %}checked{% endif %}>
            </label>
            <label>Balance weight:
                <input type="number" name="balance_weight" value="{{ config['balance_weight'] }}" min="1">
            </label>
        </fieldset>
        <fieldset>
            <legend>Subjects</legend>
            {% for sub in subjects %}
            <input type="hidden" name="subject_id" value="{{ sub['id'] }}">
            <label>Name: <input type="text" name="subject_name_{{ sub['id'] }}" value="{{ sub['name'] }}"></label>
            <label>Min %: <input type="number" name="subject_min_{{ sub['id'] }}" value="{{ sub['min_percentage'] if sub['min_percentage'] is not none else 0 }}" min="0" max="100"></label>
            <label>Delete? <input type="checkbox" name="subject_delete" value="{{ sub['id'] }}"></label><br>
            {% endfor %}
            <label>New Subject: <input type="text" name="new_subject_name"></label>
            <label>Min %: <input type="number" name="new_subject_min" min="0" max="100"></label><br>
        </fieldset>
        <fieldset>
            <legend>Teachers</legend>
            {% for t in teachers %}
            <input type="hidden" name="teacher_id" value="{{ t['id'] }}">
            <label>Name: <input type="text" name="teacher_name_{{ t['id'] }}" value="{{ t['name'] }}"></label>
            <label>Subjects:
                <select multiple name="teacher_subjects_{{ t['id'] }}">
                    {% for sub in subjects %}
                    <option value="{{ sub['name'] }}" {% if sub['name'] in json.loads(t['subjects']) %}selected{% endif %}>{{ sub['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Min: <input type="number" name="teacher_min_{{ t['id'] }}" value="{{ t['min_lessons'] if t['min_lessons'] is not none else '' }}"></label>
            <label>Max: <input type="number" name="teacher_max_{{ t['id'] }}" value="{{ t['max_lessons'] if t['max_lessons'] is not none else '' }}"></label>
            <label>Delete? <input type="checkbox" name="teacher_delete_{{ t['id'] }}" value="1"></label><br>
            {% endfor %}
            <label>New Name: <input type="text" name="new_teacher_name"></label>
            <label>Subjects:
                <select multiple name="new_teacher_subjects">
                    {% for sub in subjects %}
                    <option value="{{ sub['name'] }}">{{ sub['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Min: <input type="number" name="new_teacher_min"></label>
            <label>Max: <input type="number" name="new_teacher_max"></label><br>
        </fieldset>
        <fieldset>
            <legend>Students</legend>
            {% for s in students %}
            <input type="hidden" name="student_id" value="{{ s['id'] }}">
            <label>Name: <input type="text" name="student_name_{{ s['id'] }}" value="{{ s['name'] }}"></label>
            <label>Subjects:
                <select multiple name="student_subjects_{{ s['id'] }}">
                    {% for sub in subjects %}
                    <option value="{{ sub['name'] }}" {% if sub['name'] in json.loads(s['subjects']) %}selected{% endif %}>{{ sub['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Needs lessons? <input type="checkbox" name="student_active_{{ s['id'] }}" value="1" {% if s['active'] %}checked{% endif %}></label>
            <label>Forbidden Teachers:
                <select multiple name="student_block_{{ s['id'] }}">
                    {% for t in teachers %}
                    <option value="{{ t['id'] }}" {% if t['id'] in block_map.get(s['id'], []) %}selected{% endif %}>{{ t['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Delete? <input type="checkbox" name="student_delete_{{ s['id'] }}" value="1"></label><br>
            {% endfor %}
            <label>New Name: <input type="text" name="new_student_name"></label>
            <label>Subjects:
                <select multiple name="new_student_subjects">
                    {% for sub in subjects %}
                    <option value="{{ sub['name'] }}">{{ sub['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Forbidden Teachers:
                <select multiple name="new_student_block">
                    {% for t in teachers %}
                    <option value="{{ t['id'] }}">{{ t['name'] }}</option>
                    {% endfor %}
                </select>
            </label><br>
        </fieldset>
        <fieldset>
            <legend>Groups</legend>
            {% for g in groups %}
            <input type="hidden" name="group_id" value="{{ g['id'] }}">
            <label>Name: <input type="text" name="group_name_{{ g['id'] }}" value="{{ g['name'] }}"></label>
            <label>Subjects:
                <select multiple name="group_subjects_{{ g['id'] }}">
                    {% for sub in subjects %}
                    <option value="{{ sub['name'] }}" {% if sub['name'] in json.loads(g['subjects']) %}selected{% endif %}>{{ sub['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Members:
                <select multiple name="group_members_{{ g['id'] }}">
                    {% for s in students %}
                    <option value="{{ s['id'] }}" {% if s['id'] in group_map.get(g['id'], []) %}selected{% endif %}>{{ s['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Delete? <input type="checkbox" name="group_delete" value="{{ g['id'] }}"></label><br>
            {% endfor %}
            <label>New Group Name: <input type="text" name="new_group_name"></label>
            <label>Subjects:
                <select multiple name="new_group_subjects">
                    {% for sub in subjects %}
                    <option value="{{ sub['name'] }}">{{ sub['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Members:
                <select multiple name="new_group_members">
                    {% for s in students %}
                    <option value="{{ s['id'] }}">{{ s['name'] }}</option>
                    {% endfor %}
                </select>
            </label><br>
        </fieldset>
        <fieldset>
            <legend>Teacher Unavailability</legend>
            {% for u in unavailable %}
            <input type="hidden" name="unavail_id" value="{{ u['id'] }}">
            <span>{{ u['teacher_name'] }} - Slot {{ u['slot'] + 1 }}</span>
            <label>Delete? <input type="checkbox" name="unavail_delete" value="{{ u['id'] }}"></label><br>
            {% endfor %}
            <label>Teacher:
                <select name="new_unavail_teacher" id="new_unavail_teacher">
                    {% for t in teachers %}
                    <option value="{{ t['id'] }}">{{ t['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Slot: <input type="number" name="new_unavail_slot" id="new_unavail_slot" min="1" max="{{ config['slots_per_day'] }}"></label><br>
        </fieldset>
        <fieldset>
            <legend>Fixed Assignments</legend>
            {% for a in assignments %}
            <input type="hidden" name="assign_id" value="{{ a['id'] }}">
            <span>
                {% if a['student_name'] %}{{ a['student_name'] }}{% else %}{{ a['group_name'] }}{% endif %} -
                {{ a['subject'] }} with {{ a['teacher_name'] }} at Slot {{ a['slot'] + 1 }}
            </span>
            <label>Delete? <input type="checkbox" name="assign_delete" value="{{ a['id'] }}"></label><br>
            {% endfor %}
            <label>Student:
                <select name="new_assign_student" id="new_assign_student">
                    <option value="">-- None --</option>
                    {% for s in students %}
                    <option value="{{ s['id'] }}">{{ s['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Group:
                <select name="new_assign_group" id="new_assign_group">
                    <option value="">-- None --</option>
                    {% for g in groups %}
                    <option value="{{ g['id'] }}">{{ g['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Teacher:
                <select name="new_assign_teacher" id="new_assign_teacher">
                    {% for t in teachers %}
                    <option value="{{ t['id'] }}">{{ t['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Subject:
                <select name="new_assign_subject" id="new_assign_subject">
                    <option value="">-- Select --</option>
                </select>
            </label>
            <label>Slot:
                <select name="new_assign_slot" id="new_assign_slot" data-total-slots="{{ config['slots_per_day'] }}">
                    <option value="">-- Select --</option>
                </select>
            </label><br>
        </fieldset>
        <button type="submit">Save</button>
    </form>

    <form method="post" action="{{ url_for('reset_db') }}" onsubmit="return confirm('This will erase all data and reset to defaults. Continue?');">
        <button type="submit">Reset Database</button>
    </form>
    <p><a href="{{ url_for('index') }}">Back to Home</a></p>
    <script id="teacher-data" type="application/json">{{ teacher_map | tojson }}</script>
    <script id="student-data" type="application/json">{{ student_map | tojson }}</script>
    <script id="group-data" type="application/json">{{ group_subj_map | tojson }}</script>
    <script id="unavail-data" type="application/json">{{ unavail_map | tojson }}</script>
    <script id="assign-data" type="application/json">{{ assign_map | tojson }}</script>
    <script src="{{ url_for('static', filename='config.js') }}"></script>
</body>
</html>
