<!-- Configuration page with a long form for teachers, students, groups and settings -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='dist/app.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='flowbite-accordion-selectinput-fix.css') }}">    
    <style>
    /* Fix bottom rounding and border visibility for the last accordion item */
    #heading-assign > button[aria-expanded="true"] {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        border-bottom-width: 0;
    }
    #heading-assign > button[aria-expanded="false"] {
        border-bottom-left-radius: 0.75rem; /* ~ rounded-b-xl */
        border-bottom-right-radius: 0.75rem;
    }
    /* Ensure body’s top corners are square to meet the header cleanly */
    #body-assign {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }
    .repeat-control.repeat-disabled {
        opacity: 0.6;
    }
    </style>
</head>
<body class="bg-emerald-50 min-h-screen">
    <div class="max-w-4xl mx-auto mt-10 p-6">
    <h1 class="text-2xl text-emerald-900 font-semibold mb-4 text-center">Configuration</h1>
    <ul class="flex justify-center text-lg text-center text-emerald-700 border-b border-emerald-200 dark:text-emerald-300 dark:border-emerald-700 mb-6" role="tablist">
        <li class="me-2">
            <a href="{{ url_for('index') }}" class="inline-block p-4 border-b-2 rounded-t-lg text-lg {% if request.endpoint == 'index' %}border-emerald-500 text-emerald-700{% else %}border-transparent hover:text-emerald-600 hover:border-emerald-300 dark:hover:text-emerald-300{% endif %}">Home</a>
        </li>
        <li class="me-2">
            <a href="{{ url_for('config') }}" class="inline-block p-4 border-b-2 rounded-t-lg text-lg {% if request.endpoint == 'config' %}border-emerald-500 text-emerald-700{% else %}border-transparent hover:text-emerald-600 hover:border-emerald-300 dark:hover:text-emerald-300{% endif %}">Edit Configuration</a>
        </li>
        <li class="me-2">
            <a href="{{ url_for('attendance') }}" class="inline-block p-4 border-b-2 rounded-t-lg text-lg {% if request.endpoint == 'attendance' %}border-emerald-500 text-emerald-700{% else %}border-transparent hover:text-emerald-600 hover:border-emerald-300 dark:hover:text-emerald-300{% endif %}">View Attendance</a>
        </li>
        <li class="me-2">
            <a href="{{ url_for('manage_timetables') }}" class="inline-block p-4 border-b-2 rounded-t-lg text-lg {% if request.endpoint == 'manage_timetables' %}border-emerald-500 text-emerald-700{% else %}border-transparent hover:text-emerald-600 hover:border-emerald-300 dark:hover:text-emerald-300{% endif %}">Manage Timetables</a>
        </li>
    </ul>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <script type="application/json" data-flash-payload>{{ messages|tojson }}</script>
    {% endif %}
    {% endwith %}
    <div class="mb-6">
        <h2 class="text-xl text-emerald-900 font-semibold mb-2">Presets</h2>
        <form method="post" action="{{ url_for('save_preset') }}" class="flex gap-2 mb-2">
            <input type="text" name="name" placeholder="Preset name" class="border border-emerald-300 rounded-lg p-2.5 flex-1">
            <button type="submit" class="bg-emerald-500 text-white px-4 py-2 rounded">Save</button>
        </form>
        <form id="load-form" method="post" action="{{ url_for('load_preset') }}" class="flex gap-2">
            <select name="preset_id" class="border border-emerald-300 rounded-lg p-2.5 flex-1">
                {% for p in presets %}
                <option value="{{ p['id'] }}">{{ p['name'] }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="overwrite" id="overwrite" value="0">
            <input type="hidden" name="selected_sections" id="selected-sections-input" value="">
            <button type="button" data-preset-load class="bg-emerald-500 text-white px-4 py-2 rounded">Load</button>
            <button type="submit" formaction="{{ url_for('delete_preset') }}" class="bg-red-500 text-white px-4 py-2 rounded">Delete</button>
        </form>
    </div>

    <div id="load-preset-modal" tabindex="-1" aria-hidden="true" class="hidden fixed top-0 right-0 left-0 z-50 flex justify-center items-center w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full bg-black/30">
        <div class="relative p-4 w-full max-w-md max-h-full">
            <div class="relative bg-white rounded-lg shadow">
                <div class="p-4 space-y-4">
                    <h3 class="text-lg font-semibold text-emerald-900">Load preset sections</h3>
                    <p class="text-sm text-emerald-800">Choose which sections to overwrite when loading the preset.</p>
                    <div class="space-y-2">
                        {% for key, label in preset_sections.items() %}
                        <label class="flex items-center gap-2 text-sm text-emerald-900">
                            <input type="checkbox"
                                   data-preset-section
                                   data-section-label="{{ label }}"
                                   data-section-deps='{{ preset_section_dependencies.get(key, []) | tojson }}'
                                   data-section-note="{{ preset_section_notes.get(key, '') }}"
                                   value="{{ key }}"
                                   checked
                                   class="w-4 h-4 text-emerald-600 border-emerald-300 rounded focus:ring-emerald-500">
                            <span>{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="hidden bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-900 space-y-2" data-selection-evaluation>
                        <p class="font-semibold">Some sections stay locked to keep related settings working:</p>
                        <ul class="list-disc ms-5 space-y-1" data-selection-evaluation-list></ul>
                    </div>
                    <p class="text-xs text-emerald-700">Timetables and worksheets are never changed when loading a preset.</p>
                    <div class="flex justify-end gap-2 pt-2">
                        <button type="button" data-preset-load-cancel class="border border-emerald-300 text-emerald-700 px-3 py-2 rounded hover:bg-emerald-50 transition">Cancel</button>
                        <button type="button" id="confirm-load-preset" class="bg-emerald-500 text-white px-3 py-2 rounded hover:bg-emerald-600 transition">Load selected</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<form id="config-form" method="post" class="space-y-6 config-form">
<div id="config-accordion" data-accordion="open" data-active-classes="bg-emerald-300" data-inactive-classes="text-grey-900" class="mb-4">
    <!-- Help & Guidance -->
    <h2 id="heading-help">
        <button type="button" class="flex items-center justify-between w-full p-4 font-medium text-left border border-b-0 border-emerald-200 rounded-t-xl hover:bg-emerald-300"
            data-accordion-target="#body-help" aria-expanded="false" aria-controls="body-help">
            <span>Help & Guidance</span>
            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
            </svg>
        </button>
    </h2>
    <div id="body-help" class="hidden p-4 border border-b-0 border-emerald-200">
        <div class="prose max-w-none text-sm text-emerald-900">
            <h3 class="text-base font-semibold text-emerald-900">Weights &amp; Toggles</h3>
            <p class="leading-6">Weights and toggles control solver priorities and feasibility rules. Weights are relative (larger means stronger preference), and values are internally scaled for the solver—keep using the same units.</p>
            <ul class="list-disc ms-6 mb-6 space-y-1">
                <li><strong>Min/Max lessons per student:</strong> Set global defaults. Student overrides in <em>Advanced</em> take precedence.</li>
                <li><strong>Teacher min/max lessons:</strong> Provide defaults that are used when a teacher’s own limits are blank.</li>
                <li><strong>Allow repeated lessons:</strong> If disabled, each student–teacher–subject combination can occur at most once.</li>
                <li><strong>Max repeats:</strong> Cap repeats when they are allowed (applies per student–teacher–subject).</li>
                <li><strong>Repeatable subjects:</strong> Limit which subjects may repeat for a student; leave blank to allow all of their subjects.</li>
                <li><strong>Allow consecutive repeats:</strong> When off, repeated lessons for the same triple cannot be adjacent slots.</li>
                <li><strong>Prefer consecutive repeats:</strong> Adds a bonus for back-to-back repeats (only effective when consecutive repeats are allowed).</li>
                <li><strong>Allow different teachers per subject:</strong> If disabled, a student can study a subject with at most one teacher (repeats with that teacher remain allowed).</li>
                <li><strong>Require all subjects:</strong> Guarantees each active student receives at least one lesson for every listed subject.</li>
                <li><strong>Use attendance priority:</strong> Redirects lessons toward subjects that fall below their <em>Min&nbsp;%</em> target.</li>
                <li><strong>Balance teacher load:</strong> When enabled, the solver discourages uneven totals between teachers.</li>
            </ul>

            <h3 class="text-base font-semibold text-emerald-900">Weight controls</h3>
            <ul class="list-disc ms-6 mb-6 space-y-1">
                <li><strong>Consecutive preference weight:</strong> Sets the bonus for scheduling repeated lessons back-to-back when <em>Prefer consecutive repeats</em> is on (typical 1–3).</li>
                <li><strong>Attendance weight:</strong> Bonus added when attendance is below the <em>Min&nbsp;%</em> target; higher values more strongly pull lessons toward low-attendance subjects (typical 5–25).</li>
                <li><strong>Well-attended weight:</strong> Baseline weight applied to subjects already meeting their attendance target; lowering it reduces focus on subjects that are on track (typical 0.5–2.0).</li>
                <li><strong>Group weight:</strong> Multiplier that biases the solver toward selecting group lessons (typical 1.0–3.0). Set to 0 to remove the bias.</li>
                <li><strong>Balance weight:</strong> Controls how strongly uneven teacher workloads are penalised when <em>Balance teacher load</em> is enabled (typical 5–15).</li>
            </ul>

            <h3 class="text-base font-semibold text-emerald-900">Attendance Priority (optional)</h3>
            <ul class="list-disc ms-6 mb-6 space-y-1">
                <li>Enable <em>Attendance Priority</em> to favor subjects where a student’s attendance percentage is below the <em>Subjects → Min %</em> threshold.</li>
                <li>Below-target subjects scale from <em>well_attend_weight</em> up to <em>well_attend_weight</em> + <em>attendance_weight</em> based on how far the attendance percentage is from the target.</li>
                <li>Groups use the median attendance among members to decide the weight.</li>
                <li>Using <em>Require All Subjects</em> together with <em>Attendance Priority</em> can increase solve time.</li>
            </ul>

            <h3 class="text-base font-semibold text-emerald-900">Locations (optional)</h3>
            <ul class="list-disc ms-6 mb-6 space-y-1">
                <li>Without locations, lessons are scheduled with no location constraints.</li>
                <li>With locations, each lesson receives a location and each slot can host at most one lesson per location.</li>
                <li>Use <em>Student/Group → Locations</em> to restrict which locations specific entities may use.</li>
            </ul>

            <h3 class="text-base font-semibold text-emerald-900">Unavailability &amp; Blocking</h3>
            <ul class="list-disc ms-6 mb-6 space-y-1">
                <li><em>Teacher Unavailability</em> marks slots a teacher cannot teach.</li>
                <li><em>Student Advanced → Blocked Slots</em> prevents any lesson for that student in the selected slots.</li>
                <li><em>Student → Forbidden Teachers</em> blocks specific teachers for that student. Group pseudo-students inherit the union of member blocks.</li>
            </ul>

            <h3 class="text-base font-semibold text-emerald-900">Fixed Assignments</h3>
            <ul class="list-disc ms-6 mb-6 space-y-1">
                <li>Use to force specific teacher, student (or group), subject, and slot combinations.</li>
                <li>Optionally attach a location to reserve a room or resource for that lesson; the solver treats it as a hard requirement.</li>
                <li>If both a student and a group are selected, the entry is saved for the group only when <em>group_weight &gt; 0</em> (or no student is chosen).</li>
            </ul>

            <h3 class="text-base font-semibold text-emerald-900">Batch tools &amp; per-student overrides</h3>
            <ul class="list-disc ms-6 mb-6 space-y-1">
                <li>Use the <em>Batch student actions</em> panel to add or remove blocked slots, subjects, teacher blocks, allowed locations, and toggle the <em>Needs lessons?</em> status for several students at once. Batch updates merge with existing values rather than replacing them outright.</li>
                <li>The <em>Needs lessons?</em> toggle lets you temporarily archive a student without deleting their configuration—turn it off to keep historical data while skipping the student during scheduling.</li>
                <li>Advanced dialogs provide per-student overrides for Min/Max lessons, repeat allowances, repeatable subjects, consecutive preferences, teacher-per-subject limits, and blocked slots.</li>
                <li>Overrides apply only to the selected student and take priority over global defaults.</li>
            </ul>

            <h3 class="text-base font-semibold text-emerald-900">Validation reminders for a healthy configuration</h3>
            <ul class="list-disc ms-6 space-y-1">
                <li><strong>Slots per day &amp; slot duration:</strong> Use positive integers. Provide a start time for every slot, and make each start at least one <em>slot duration</em> after the previous start.</li>
                <li><strong>Global lesson limits:</strong> Student and teacher minimums/maximums must be zero or greater, the minimum cannot exceed the maximum, and both must be no higher than the number of slots per day.</li>
                <li><strong>Per-person overrides:</strong> Teacher and student overrides follow the same non-negative, min ≤ max, ≤ slots-per-day rules. Student minimums must fit within the remaining slots after marking unavailability.</li>
                <li><strong>Repeat options:</strong> Repeat settings apply only when <em>Allow repeated lessons?</em> is enabled. With repeats on, <em>Max repeats</em> must be at least 2, <em>Prefer consecutive</em> requires <em>Allow consecutive</em>, and <em>consecutive_weight</em> must be an integer ≥ 1.</li>
                <li><strong>Objective weights:</strong> <em>attendance_weight</em> and <em>balance_weight</em> must be positive integers. <em>well_attend_weight</em> and <em>group_weight</em> must be zero or greater—negative values are rejected.</li>
                <li><strong>Solver time limit:</strong> Enter a positive integer (seconds) or leave blank to keep the saved limit.</li>
                <li><strong>Groups &amp; teachers:</strong> Every group needs at least one subject and member. Each subject must be required by all members and have an available teacher who is not blocked.</li>
                <li><strong>Teacher blocks:</strong> You cannot block a teacher if that removes the only available teacher for a required group subject or conflicts with a fixed assignment.</li>
                <li><strong>Deleting students:</strong> Remove the student from all groups and fixed assignments before deletion; the form prevents deletions that violate those rules.</li>
            </ul>
        </div>
    </div>
    <!-- General settings -->
    <h2 id="heading-general">
        <button type="button" class="flex items-center justify-between w-full p-4 font-medium text-left border border-b-0 border-emerald-200 hover:bg-emerald-300"
            data-accordion-target="#body-general" aria-expanded="true" aria-controls="body-general">
            <span>General</span>
            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
            </svg>
        </button>
    </h2>
    <div id="body-general" class="p-4 border border-b-0 border-emerald-200">
        <fieldset class="grid gap-4">
            <label class="block">Slots per day:
                <input type="number" name="slots_per_day" value="{{ config['slots_per_day'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Slot duration (minutes):
                <input type="number" name="slot_duration" value="{{ config['slot_duration'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <div id="slot-times" class="space-y-2">
                {% for i in range(config['slots_per_day']) %}
                <label class="block">Slot {{ i + 1 }} start:
                    <input type="time" name="slot_start_{{ i + 1 }}" value="{{ slot_times[i] if slot_times|length > i else '' }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                </label>
                {% endfor %}
            </div>
            <label class="block">Min lessons per student:
                <input type="number" name="min_lessons" value="{{ config['min_lessons'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Max lessons per student:
                <input type="number" name="max_lessons" value="{{ config['max_lessons'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Min lessons per teacher:
                <input type="number" name="teacher_min_lessons" value="{{ config['teacher_min_lessons'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Max lessons per teacher:
                <input type="number" name="teacher_max_lessons" value="{{ config['teacher_max_lessons'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="flex items-center gap-2" for="allow_repeats">Allow repeated lessons?
                <input id="allow_repeats" type="checkbox" name="allow_repeats" data-repeat-target="max_repeats allow_consecutive prefer_consecutive consecutive_weight" {% if config['allow_repeats'] %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="flex items-center gap-2">Allow different teachers per subject?
                <input type="checkbox" name="allow_multi_teacher" {% if config['allow_multi_teacher'] %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="block repeat-control {% if not config['allow_repeats'] %}repeat-disabled{% endif %}" for="max_repeats">Max repeats per teacher/subject:
                <input id="max_repeats" type="number" name="max_repeats" value="{{ config['max_repeats'] }}" min="2" data-repeat-off-value="1" {% if not config['allow_repeats'] %}disabled{% endif %} class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="flex items-center gap-2 repeat-control {% if not config['allow_repeats'] %}repeat-disabled{% endif %}" for="allow_consecutive">Allow consecutive repeat slots?
                <input id="allow_consecutive" type="checkbox" name="allow_consecutive" {% if config['allow_consecutive'] %}checked{% endif %} {% if not config['allow_repeats'] %}disabled{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="flex items-center gap-2 repeat-control {% if not config['allow_repeats'] %}repeat-disabled{% endif %}" for="prefer_consecutive">Prefer consecutive repeats?
                <input id="prefer_consecutive" type="checkbox" name="prefer_consecutive" {% if config['prefer_consecutive'] %}checked{% endif %} {% if not config['allow_repeats'] %}disabled{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="block repeat-control {% if not config['allow_repeats'] %}repeat-disabled{% endif %}" for="consecutive_weight">Consecutive preference weight:
                <input id="consecutive_weight" type="number" name="consecutive_weight" value="{{ config['consecutive_weight'] }}" min="1" data-repeat-disable-mode="readonly" {% if not config['allow_repeats'] %}readonly aria-disabled="true"{% endif %} class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="flex items-center gap-2">Require all subjects?
                <input type="checkbox" name="require_all_subjects" {% if config['require_all_subjects'] %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="flex items-center gap-2">Use attendance priority?
                <input type="checkbox" name="use_attendance_priority" {% if config['use_attendance_priority'] %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="block">Attendance weight:
                <input type="number" name="attendance_weight" value="{{ config['attendance_weight'] }}" min="1" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Well-attended weight:
                <input type="number" name="well_attend_weight" value="{{ config['well_attend_weight'] }}" min="0" step="0.1" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Group weight:
                <input type="number" name="group_weight" value="{{ config['group_weight'] }}" min="0" step="0.1" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="flex items-center gap-2">Balance teacher load?
                <input type="checkbox" name="balance_teacher_load" {% if config['balance_teacher_load'] %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="block">Balance weight:
                <input type="number" name="balance_weight" value="{{ config['balance_weight'] }}" min="1" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Solver time limit (seconds):
                <input type="number" name="solver_time_limit" value="{{ config['solver_time_limit']|default(120, true) }}" min="1" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
        </fieldset>
    </div>
    <!-- Subjects -->
    <h2 id="heading-subjects">
        <button type="button" class="flex items-center justify-between w-full p-4 font-medium text-left border border-b-0 border-emerald-200 hover:bg-emerald-300"
            data-accordion-target="#body-subjects" aria-expanded="false" aria-controls="body-subjects">
            <span>Subjects</span>
            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
            </svg>
        </button>
    </h2>
    <div id="body-subjects" class="hidden p-4 border border-b-0 border-emerald-200">
        <fieldset class="space-y-4">
            {% for sub in subjects %}
            <input type="hidden" name="subject_id" value="{{ sub['id'] }}">
            <label class="block">Name:
                <input type="text" name="subject_name_{{ sub['id'] }}" value="{{ sub['name'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Min %:
                <input type="number" name="subject_min_{{ sub['id'] }}" value="{{ sub['min_percentage'] if sub['min_percentage'] is not none else 0 }}" min="0" max="100" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="flex items-center gap-2">Delete?
                <input type="checkbox" name="subject_delete" value="{{ sub['id'] }}" class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            {% endfor %}
            <label class="block">New Subject:
                <input type="text" name="new_subject_name" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Min %:
                <input type="number" name="new_subject_min" min="0" max="100" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
        </fieldset>
    </div>
    <!-- Teachers -->
    <h2 id="heading-teachers">
        <button type="button" class="flex items-center justify-between w-full p-4  font-medium text-left border border-b-0 border-emerald-200 hover:bg-emerald-300"
            data-accordion-target="#body-teachers" aria-expanded="false" aria-controls="body-teachers">
            <span>Teachers</span>
            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
            </svg>
        </button>
    </h2>
    <div id="body-teachers" class="hidden p-4 border border-b-0 border-emerald-200">
        <fieldset class="space-y-4">
            {% for t in teachers %}
            <input type="hidden" name="teacher_id" value="{{ t['id'] }}">
            <label class="block">Name:
                <input type="text" name="teacher_name_{{ t['id'] }}" value="{{ t['name'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Subjects:
                  <select multiple name="teacher_subjects_{{ t['id'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                      {% for sub in subjects %}
                      <option value="{{ sub['id'] }}" {% if sub['id'] in teacher_map[t['id']] %}selected{% endif %}>{{ sub['name'] }}</option>
                      {% endfor %}
                  </select>
            </label>
            <label class="flex items-center gap-2">Need lessons?
                <input type="checkbox" name="teacher_need_lessons_{{ t['id'] }}" value="1" {% if t['needs_lessons']|default(1) %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="block">Min:
                <input type="number" name="teacher_min_{{ t['id'] }}" value="{{ t['min_lessons'] if t['min_lessons'] is not none else '' }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Max:
                <input type="number" name="teacher_max_{{ t['id'] }}" value="{{ t['max_lessons'] if t['max_lessons'] is not none else '' }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="flex items-center gap-2">Delete?
                <input type="checkbox" name="teacher_delete_{{ t['id'] }}" value="1" class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            {% endfor %}
            <label class="block">New Name:
                <input type="text" name="new_teacher_name" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Subjects:
                  <select multiple name="new_teacher_subjects" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                      {% for sub in subjects %}
                      <option value="{{ sub['id'] }}">{{ sub['name'] }}</option>
                      {% endfor %}
                  </select>
            </label>
            <label class="flex items-center gap-2">Need lessons?
                <input type="checkbox" name="new_teacher_need_lessons" value="1" checked class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="block">Min:
                <input type="number" name="new_teacher_min" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Max:
                <input type="number" name="new_teacher_max" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
        </fieldset>
    </div>
    <!-- Students -->
    <h2 id="heading-students">
        <button type="button" class="flex items-center justify-between w-full p-4  font-medium text-left border border-b-0 border-emerald-200 hover:bg-emerald-300"
            data-accordion-target="#body-students" aria-expanded="false" aria-controls="body-students">
            <span>Students</span>
            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
            </svg>
        </button>
    </h2>
    <div id="body-students" class="hidden p-4 border border-b-0 border-emerald-200">
        <fieldset class="space-y-4 mb-8 border border-emerald-200 rounded-lg p-4 bg-emerald-50/50" aria-labelledby="batch-student-actions-heading">
            <legend id="batch-student-actions-heading" class="font-semibold text-emerald-900">Batch student actions</legend>
            <p class="text-sm text-emerald-700">Select one or more students and apply shared changes. Batch updates merge with each student&rsquo;s existing values, and removals respect current group and timetable constraints.</p>
            <label class="block">
                <span class="font-medium">Students</span>
                <select multiple name="batch_students" class="border border-emerald-300 rounded-lg p-2.5 w-full" size="6">
                    {% for s in students %}
                    <option value="{{ s['id'] }}">{{ s['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <div class="grid gap-4 md:grid-cols-2">
                <fieldset class="space-y-2">
                    <legend class="font-medium">Blocked slots</legend>
                    <p class="text-sm text-emerald-700">Add or remove blocked slots for every selected student.</p>
                    <label class="block">
                        <span class="sr-only">Blocked slot action</span>
                        <select name="batch_block_action" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                            <option value="add">Add selected slots</option>
                            <option value="remove">Remove selected slots</option>
                        </select>
                    </label>
                    <select multiple name="batch_block_slots" class="border border-emerald-300 rounded-lg p-2.5 w-full" size="6">
                        {% for i in range(config['slots_per_day']) %}
                        <option value="{{ i + 1 }}">Slot {{ i + 1 }}</option>
                        {% endfor %}
                    </select>
                </fieldset>
                <fieldset class="space-y-2">
                    <legend class="font-medium">Subjects</legend>
                    <p class="text-sm text-emerald-700">Apply subject adds or removals. Removing a subject also removes repeats if the subject is no longer assigned.</p>
                    <label class="block">
                        <span class="sr-only">Subject action</span>
                        <select name="batch_subject_action" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                            <option value="add">Add selected subjects</option>
                            <option value="remove">Remove selected subjects</option>
                        </select>
                    </label>
                    <select multiple name="batch_subjects" class="border border-emerald-300 rounded-lg p-2.5 w-full" size="6">
                        {% for sub in subjects %}
                        <option value="{{ sub['id'] }}">{{ sub['name'] }}</option>
                        {% endfor %}
                    </select>
                </fieldset>
                <fieldset class="space-y-2">
                    <legend class="font-medium">Teacher blocks</legend>
                    <p class="text-sm text-emerald-700">Block or unblock teachers for all selected students. Blocks prevent those teachers from being assigned during scheduling.</p>
                    <label class="block">
                        <span class="sr-only">Teacher action</span>
                        <select name="batch_teacher_action" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                            <option value="add">Block selected teachers</option>
                            <option value="remove">Unblock selected teachers</option>
                        </select>
                    </label>
                    <select multiple name="batch_teacher_targets" class="border border-emerald-300 rounded-lg p-2.5 w-full" size="6">
                        {% for t in teachers %}
                        <option value="{{ t['id'] }}">{{ t['name'] }}</option>
                        {% endfor %}
                    </select>
                </fieldset>
                <fieldset class="space-y-2">
                    <legend class="font-medium">Allowed locations</legend>
                    <p class="text-sm text-emerald-700">Add or remove allowed locations for all selected students. Locations limit where lessons may be scheduled.</p>
                    <label class="block">
                        <span class="sr-only">Location action</span>
                        <select name="batch_location_action" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                            <option value="add">Add selected locations</option>
                            <option value="remove">Remove selected locations</option>
                        </select>
                    </label>
                    <select multiple name="batch_locations" class="border border-emerald-300 rounded-lg p-2.5 w-full" size="6">
                        {% for loc in locations %}
                        <option value="{{ loc['id'] }}">{{ loc['name'] }}</option>
                        {% endfor %}
                    </select>
                </fieldset>
                <fieldset class="space-y-2 md:col-span-2">
                    <legend class="font-medium">Needs lessons status</legend>
                    <p class="text-sm text-emerald-700">Toggle whether the selected students are scheduled for lessons.</p>
                    <label class="block">
                        <span class="sr-only">Needs lessons action</span>
                        <select name="batch_active_action" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                            <option value="">No change</option>
                            <option value="activate">Mark as needs lessons</option>
                            <option value="deactivate">Mark as doesn&rsquo;t need lessons</option>
                        </select>
                    </label>
                </fieldset>
            </div>
        </fieldset>
        <fieldset class="space-y-4">
            {% for s in students %}
            <input type="hidden" name="student_id" value="{{ s['id'] }}">
            <label class="block">Name:
                <input type="text" name="student_name_{{ s['id'] }}" value="{{ s['name'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Subjects:
                  <select multiple name="student_subjects_{{ s['id'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                      {% for sub in subjects %}
                      <option value="{{ sub['id'] }}" {% if sub['id'] in student_map[s['id']] %}selected{% endif %}>{{ sub['name'] }}</option>
                      {% endfor %}
                  </select>
            </label>
            <label class="flex items-center gap-2">Needs lessons?
                <input type="checkbox" name="student_active_{{ s['id'] }}" value="1" {% if s['active'] %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            <label class="block">Forbidden Teachers:
                <select multiple name="student_block_{{ s['id'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for t in teachers %}
                    <option value="{{ t['id'] }}" {% if t['id'] in block_map.get(s['id'], []) %}selected{% endif %}>{{ t['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="block">Locations:
                <select multiple name="student_locs_{{ s['id'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for loc in locations %}
                    <option value="{{ loc['id'] }}" {% if loc['id'] in student_loc_map.get(s['id'], []) %}selected{% endif %}>{{ loc['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="button" data-modal-target="adv-{{ s['id'] }}" data-modal-toggle="adv-{{ s['id'] }}" class="bg-emerald-200 text-emerald-800 px-2 py-1 rounded">Advanced</button>
            <div id="adv-{{ s['id'] }}" tabindex="-1" aria-hidden="true" data-config-modal class="hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
                <div class="relative p-4 w-full max-w-md max-h-full">
                    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                        <div class="p-4">
                            <h3 class="text-lg mb-2">Advanced settings for {{ s['name'] }}</h3>
                            {% set student_allow_repeats = s['allow_repeats'] if s['allow_repeats'] is not none else config['allow_repeats'] %}
                            <label class="block">Blocked Slots:
                                <select multiple name="student_unavail_{{ s['id'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                                    {% for i in range(config['slots_per_day']) %}
                                    <option value="{{ i }}" {% if i in student_unavail_map.get(s['id'], []) %}selected{% endif %}>Slot {{ i + 1 }}</option>
                                    {% endfor %}
                                </select>
                            </label>
                            <label class="block">Min lessons:
                                <input type="number" name="student_min_{{ s['id'] }}" value="{{ s['min_lessons'] if s['min_lessons'] is not none else config['min_lessons'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                            </label>
                            <label class="block">Max lessons:
                                <input type="number" name="student_max_{{ s['id'] }}" value="{{ s['max_lessons'] if s['max_lessons'] is not none else config['max_lessons'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                            </label>
                            <label class="flex items-center gap-2">Allow repeated lessons?
                                <input type="checkbox" name="student_allow_repeats_{{ s['id'] }}" data-repeat-target="student_repeat_subjects_{{ s['id'] }} student_max_repeats_{{ s['id'] }} student_allow_consecutive_{{ s['id'] }} student_prefer_consecutive_{{ s['id'] }}" {% if student_allow_repeats %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
                            </label>
                            <label class="block repeat-control {% if not student_allow_repeats %}repeat-disabled{% endif %}">Repeatable subjects:
                                <select id="student_repeat_subjects_{{ s['id'] }}" multiple name="student_repeat_subjects_{{ s['id'] }}" {% if not student_allow_repeats %}disabled{% endif %} class="border border-emerald-300 rounded-lg p-2.5 w-full">
                                    {% for sub in subjects %}
                                        {% if sub['id'] in student_map[s['id']] %}
                                            <option value="{{ sub['id'] }}" {% if sub['id'] in s['repeat_subjects'] %}selected{% endif %}>{{ sub['name'] }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </label>
                            <label class="flex items-center gap-2">Allow different teachers per subject?
                                <input type="checkbox" name="student_multi_teacher_{{ s['id'] }}" {% if (s['allow_multi_teacher'] if s['allow_multi_teacher'] is not none else config['allow_multi_teacher']) %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
                            </label>
                            <div class="repeat-control {% if not student_allow_repeats %}repeat-disabled{% endif %}">
                                <label class="block" for="student_max_repeats_{{ s['id'] }}">Max repeats:
                                    <input id="student_max_repeats_{{ s['id'] }}" type="number" name="student_max_repeats_{{ s['id'] }}" value="{{ s['max_repeats'] if s['max_repeats'] is not none else config['max_repeats'] }}" min="2" data-repeat-off-value="1" {% if not student_allow_repeats %}disabled{% endif %} class="border border-emerald-300 rounded-lg p-2.5 w-full">
                                </label>
                            </div>
                            <div class="repeat-control {% if not student_allow_repeats %}repeat-disabled{% endif %}">
                                <label class="flex items-center gap-2" for="student_allow_consecutive_{{ s['id'] }}">Allow consecutive repeats?
                                    <input id="student_allow_consecutive_{{ s['id'] }}" type="checkbox" name="student_allow_consecutive_{{ s['id'] }}" {% if (s['allow_consecutive'] if s['allow_consecutive'] is not none else config['allow_consecutive']) %}checked{% endif %} {% if not student_allow_repeats %}disabled{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
                                </label>
                            </div>
                            <div class="repeat-control {% if not student_allow_repeats %}repeat-disabled{% endif %}">
                                <label class="flex items-center gap-2" for="student_prefer_consecutive_{{ s['id'] }}">Prefer consecutive repeats?
                                    <input id="student_prefer_consecutive_{{ s['id'] }}" type="checkbox" name="student_prefer_consecutive_{{ s['id'] }}" {% if (s['prefer_consecutive'] if s['prefer_consecutive'] is not none else config['prefer_consecutive']) %}checked{% endif %} {% if not student_allow_repeats %}disabled{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
                                </label>
                            </div>
                            <div class="mt-4 flex justify-end gap-2">
                                <button type="button" data-modal-hide="adv-{{ s['id'] }}" data-modal-cancel class="border border-emerald-300 text-emerald-700 px-3 py-1 rounded hover:bg-emerald-50">Cancel</button>
                                <button type="button" data-modal-save class="bg-emerald-500 text-white px-3 py-1 rounded">Save changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <label class="flex items-center gap-2">Delete?
                <input type="checkbox" name="student_delete_{{ s['id'] }}" value="1" class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            {% endfor %}
            <label class="block">New Name:
                <input type="text" name="new_student_name" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Subjects:
                  <select multiple name="new_student_subjects" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                      {% for sub in subjects %}
                      <option value="{{ sub['id'] }}">{{ sub['name'] }}</option>
                      {% endfor %}
                  </select>
            </label>
            <label class="block">Forbidden Teachers:
                <select multiple name="new_student_block" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for t in teachers %}
                    <option value="{{ t['id'] }}">{{ t['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="block">Locations:
                <select multiple name="new_student_locs" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for loc in locations %}
                    <option value="{{ loc['id'] }}">{{ loc['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="button" data-modal-target="adv-new" data-modal-toggle="adv-new" class="bg-emerald-200 text-emerald-800 px-2 py-1 rounded">Advanced</button>
            <div id="adv-new" tabindex="-1" aria-hidden="true" data-config-modal class="hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
                <div class="relative p-4 w-full max-w-md max-h-full">
                    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                        <div class="p-4">
                            <h3 class="text-lg mb-2">Advanced settings for new student</h3>
                            {% set new_student_allow_repeats = config['allow_repeats'] %}
                            <label class="block">Blocked Slots:
                                <select multiple name="new_student_unavail" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                                    {% for i in range(config['slots_per_day']) %}
                                    <option value="{{ i }}">Slot {{ i + 1 }}</option>
                                    {% endfor %}
                                </select>
                            </label>
                            <label class="block">Min lessons:
                                <input type="number" name="new_student_min" value="{{ config['min_lessons'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                            </label>
                            <label class="block">Max lessons:
                                <input type="number" name="new_student_max" value="{{ config['max_lessons'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                            </label>
                            <label class="flex items-center gap-2">Allow repeated lessons?
                                <input type="checkbox" name="new_student_allow_repeats" data-repeat-target="new_student_repeat_subjects new_student_max_repeats new_student_allow_consecutive new_student_prefer_consecutive" {% if new_student_allow_repeats %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
                            </label>
                            <label class="block repeat-control {% if not new_student_allow_repeats %}repeat-disabled{% endif %}">Repeatable subjects:
                                <select id="new_student_repeat_subjects" multiple name="new_student_repeat_subjects" {% if not new_student_allow_repeats %}disabled{% endif %} class="border border-emerald-300 rounded-lg p-2.5 w-full">
                                    {% for sub in subjects %}
                                        <option value="{{ sub['id'] }}">{{ sub['name'] }}</option>
                                    {% endfor %}
                                </select>
                            </label>
                            <label class="flex items-center gap-2">Allow different teachers per subject?
                                <input type="checkbox" name="new_student_multi_teacher" {% if config['allow_multi_teacher'] %}checked{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
                            </label>
                            <div class="repeat-control {% if not new_student_allow_repeats %}repeat-disabled{% endif %}">
                                <label class="block" for="new_student_max_repeats">Max repeats:
                                    <input id="new_student_max_repeats" type="number" name="new_student_max_repeats" value="{{ config['max_repeats'] }}" min="2" data-repeat-off-value="1" {% if not new_student_allow_repeats %}disabled{% endif %} class="border border-emerald-300 rounded-lg p-2.5 w-full">
                                </label>
                            </div>
                            <div class="repeat-control {% if not new_student_allow_repeats %}repeat-disabled{% endif %}">
                                <label class="flex items-center gap-2" for="new_student_allow_consecutive">Allow consecutive repeats?
                                    <input id="new_student_allow_consecutive" type="checkbox" name="new_student_allow_consecutive" {% if config['allow_consecutive'] %}checked{% endif %} {% if not new_student_allow_repeats %}disabled{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
                                </label>
                            </div>
                            <div class="repeat-control {% if not new_student_allow_repeats %}repeat-disabled{% endif %}">
                                <label class="flex items-center gap-2" for="new_student_prefer_consecutive">Prefer consecutive repeats?
                                    <input id="new_student_prefer_consecutive" type="checkbox" name="new_student_prefer_consecutive" {% if config['prefer_consecutive'] %}checked{% endif %} {% if not new_student_allow_repeats %}disabled{% endif %} class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
                                </label>
                            </div>
                            <div class="mt-4 flex justify-end gap-2">
                                <button type="button" data-modal-hide="adv-new" data-modal-cancel class="border border-emerald-300 text-emerald-700 px-3 py-1 rounded hover:bg-emerald-50">Cancel</button>
                                <button type="button" data-modal-save class="bg-emerald-500 text-white px-3 py-1 rounded">Save changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
    </div>
    <!-- Groups -->
    <h2 id="heading-groups">
        <button type="button" class="flex items-center justify-between w-full p-4  font-medium text-left border border-b-0 border-emerald-200 hover:bg-emerald-300"
            data-accordion-target="#body-groups" aria-expanded="false" aria-controls="body-groups">
            <span>Groups</span>
            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
            </svg>
        </button>
    </h2>
    <div id="body-groups" class="hidden p-4 border border-b-0 border-emerald-200">
        <fieldset class="space-y-4">
            {% for g in groups %}
            <input type="hidden" name="group_id" value="{{ g['id'] }}">
            <label class="block">Name:
                <input type="text" name="group_name_{{ g['id'] }}" value="{{ g['name'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Subjects:
                  <select multiple name="group_subjects_{{ g['id'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                      {% for sub in subjects %}
                      <option value="{{ sub['id'] }}" {% if sub['id'] in group_subj_map[g['id']] %}selected{% endif %}>{{ sub['name'] }}</option>
                      {% endfor %}
                  </select>
            </label>
            <label class="block">Members:
                <select multiple name="group_members_{{ g['id'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for s in students %}
                    <option value="{{ s['id'] }}" {% if s['id'] in group_map.get(g['id'], []) %}selected{% endif %}>{{ s['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="block">Locations:
                <select multiple name="group_locs_{{ g['id'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for loc in locations %}
                    <option value="{{ loc['id'] }}" {% if loc['id'] in group_loc_map.get(g['id'], []) %}selected{% endif %}>{{ loc['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="flex items-center gap-2">Delete?
                <input type="checkbox" name="group_delete" value="{{ g['id'] }}" class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            {% endfor %}
            <label class="block">New Group Name:
                <input type="text" name="new_group_name" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="block">Subjects:
                  <select multiple name="new_group_subjects" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                      {% for sub in subjects %}
                      <option value="{{ sub['id'] }}">{{ sub['name'] }}</option>
                      {% endfor %}
                  </select>
            </label>
            <label class="block">Members:
                <select multiple name="new_group_members" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for s in students %}
                    <option value="{{ s['id'] }}">{{ s['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="block">Locations:
                <select multiple name="new_group_locs" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for loc in locations %}
                    <option value="{{ loc['id'] }}">{{ loc['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
        </fieldset>
    </div>
    <!-- Locations -->
    <h2 id="heading-locations">
        <button type="button" class="flex items-center justify-between w-full p-4  font-medium text-left border border-b-0 border-emerald-200 hover:bg-emerald-300"
            data-accordion-target="#body-locations" aria-expanded="false" aria-controls="body-locations">
            <span>Locations</span>
            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
            </svg>
        </button>
    </h2>
    <div id="body-locations" class="hidden p-4 border border-b-0 border-emerald-200">
        <fieldset class="space-y-4">
            {% for loc in locations %}
            <input type="hidden" name="location_id" value="{{ loc['id'] }}">
            <label class="block">Name:
                <input type="text" name="location_name_{{ loc['id'] }}" value="{{ loc['name'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
            <label class="flex items-center gap-2">Delete?
                <input type="checkbox" name="location_delete" value="{{ loc['id'] }}" class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            {% endfor %}
            <label class="block">New Location Name:
                <input type="text" name="new_location_name" class="border border-emerald-300 rounded-lg p-2.5 w-full">
            </label>
        </fieldset>
    </div>
    <!-- Unavailability -->
    <h2 id="heading-unavail">
        <button type="button" class="flex items-center justify-between w-full p-4  font-medium text-left border border-b-0 border-emerald-200 hover:bg-emerald-300"
            data-accordion-target="#body-unavail" aria-expanded="false" aria-controls="body-unavail">
            <span>Teacher Unavailability</span>
            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
            </svg>
        </button>
    </h2>
    <div id="body-unavail" class="hidden p-4 border border-b-0 border-emerald-200">
        <fieldset class="space-y-4">
            {% for u in unavailable %}
            <input type="hidden" name="unavail_id" value="{{ u['id'] }}">
            <span class="block">{{ u['teacher_name'] }} - Slot {{ u['slot'] + 1 }}</span>
            <label class="flex items-center gap-2">Delete?
                <input type="checkbox" name="unavail_delete" value="{{ u['id'] }}" class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            {% endfor %}
            <label class="block">Teachers:
                <select multiple name="new_unavail_teacher" id="new_unavail_teacher" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for t in teachers %}
                    <option value="{{ t['id'] }}">{{ t['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="block">Slots:
                <select multiple name="new_unavail_slot" id="new_unavail_slot" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for i in range(1, config['slots_per_day'] + 1) %}
                    <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
            </label>
        </fieldset>
    </div>
    <!-- Fixed assignments -->
    <h2 id="heading-assign">
        <button type="button" class="flex items-center justify-between w-full p-4 font-medium text-left border border-emerald-200 hover:bg-emerald-300 rounded-b-xl"
            data-accordion-target="#body-assign" aria-expanded="false" aria-controls="body-assign">
            <span>Fixed Assignments</span>
            <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
            </svg>
        </button>
    </h2>
    <div id="body-assign" class="hidden p-4 border border-emerald-200 rounded-b-xl">
        <fieldset class="space-y-4">
            {% for a in assignments %}
            <input type="hidden" name="assign_id" value="{{ a['id'] }}">
            <span class="block">{% if a['student_name'] %}{{ a['student_name'] }}{% else %}{{ a['group_name'] }}{% endif %} - {{ a['subject'] }} with {{ a['teacher_name'] }} at Slot {{ a['slot'] + 1 }}</span>
            <label class="flex items-center gap-2">Delete?
                <input type="checkbox" name="assign_delete" value="{{ a['id'] }}" class="w-4 h-4 text-emerald-600 bg-emerald-100 border-emerald-300 rounded focus:ring-emerald-500">
            </label>
            {% endfor %}
            <label class="block">Student:
                <select name="new_assign_student" id="new_assign_student" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    <option value="">-- None --</option>
                    {% for s in students %}
                    <option value="{{ s['id'] }}">{{ s['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="block">Group:
                <select name="new_assign_group" id="new_assign_group" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    <option value="">-- None --</option>
                    {% for g in groups %}
                    <option value="{{ g['id'] }}">{{ g['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="block">Teacher:
                <select name="new_assign_teacher" id="new_assign_teacher" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    {% for t in teachers %}
                    <option value="{{ t['id'] }}">{{ t['name'] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="block">Subject:
                <select name="new_assign_subject" id="new_assign_subject" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    <option value="">-- Select --</option>
                </select>
            </label>
            <label class="block">Slot:
                <select name="new_assign_slot" id="new_assign_slot" data-total-slots="{{ config['slots_per_day'] }}" class="border border-emerald-300 rounded-lg p-2.5 w-full">
                    <option value="">-- Select --</option>
                </select>
            </label>
        </fieldset>
    </div>
</div>
        <div class="sticky-action-bar flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-start">
            <a href="{{ url_for('index') }}" class="inline-flex w-full sm:w-auto justify-center bg-white text-emerald-700 border border-emerald-300 rounded-md px-3 py-2 hover:bg-emerald-100 transition">Cancel</a>
            <div class="flex flex-col w-full sm:w-auto items-stretch sm:items-center gap-1">
                <button type="submit" data-config-save title="Click Save or press Ctrl+Enter" class="w-full sm:w-auto bg-emerald-500 text-white border border-emerald-500 rounded-md px-3 py-2 hover:bg-emerald-600 transition">Save</button>
                <p class="text-xs text-emerald-700 text-center sm:text-right">Shortcut: <kbd>Ctrl</kbd> + <kbd>Enter</kbd></p>
            </div>
        </div>
    </form>

    <form method="post" action="{{ url_for('reset_db') }}" id="reset-db-form" class="mt-4">
        <button type="submit" class="w-full bg-red-500 text-white border rounded-md px-3 py-2 hover:bg-red-600 transition">Reset Database</button>
    </form>
    <script id="teacher-data" type="application/json">{{ teacher_map | tojson }}</script>
    <script id="student-data" type="application/json">{{ student_map | tojson }}</script>
    <!-- JSON blobs provide data for the JavaScript code below -->
    <script id="group-data" type="application/json">{{ group_subj_map | tojson }}</script>
    <script id="unavail-data" type="application/json">{{ unavail_map | tojson }}</script>
    <script id="assign-data" type="application/json">{{ assign_map | tojson }}</script>
    <script id="subject-map" type="application/json">{{ subject_map | tojson }}</script>
    <script id="slot-times-data" type="application/json">{{ slot_times | tojson }}</script>
    <script>
    function bindRepeatToggle(toggle) {
        const targetAttr = toggle.dataset.repeatTarget || '';
        const targets = targetAttr
            .split(/\s+/)
            .map(id => id && document.getElementById(id))
            .filter(Boolean);
        if (!targets.length) {
            return;
        }

        const numericTargets = targets.filter(target => target.type === 'number');

        const setNumberValue = (target, value) => {
            if (value === undefined) {
                return;
            }
            const numericValue = Number(value);
            if (!Number.isNaN(numericValue)) {
                target.value = numericValue;
            }
        };

        const updateDisabledState = () => {
            const disabled = !toggle.checked;
            const wrappers = Array.from(new Set(
                targets
                    .map(target => target.closest('.repeat-control'))
                    .filter(Boolean)
            ));

            targets.forEach(target => {
                const disableMode = target.dataset.repeatDisableMode || 'disabled';
                if (disableMode === 'readonly') {
                    target.disabled = false;
                    target.readOnly = disabled;
                } else {
                    target.disabled = disabled;
                    if (!disabled && target.readOnly) {
                        target.readOnly = false;
                    }
                }
                if (disabled) {
                    target.setAttribute('aria-disabled', 'true');
                } else {
                    target.removeAttribute('aria-disabled');
                }
                target.classList.toggle('cursor-not-allowed', disabled);
            });

            if (disabled) {
                numericTargets.forEach(target => {
                    const offValue = target.dataset.repeatOffValue;
                    setNumberValue(target, offValue);
                });
            } else {
                numericTargets.forEach(target => {
                    const minAttr = target.dataset.repeatOnMin || target.min;
                    const minValue = Number(minAttr);
                    const currentValue = Number(target.value);
                    if (!Number.isNaN(minValue) && (Number.isNaN(currentValue) || currentValue < minValue)) {
                        setNumberValue(target, minValue);
                    }
                });
            }

            wrappers.forEach(wrapper => {
                wrapper.classList.toggle('repeat-disabled', disabled);
            });
        };

        toggle.addEventListener('change', updateDisabledState);
        updateDisabledState();
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[data-repeat-target]').forEach(bindRepeatToggle);
    });
    </script>
    <script src="{{ url_for('static', filename='config.js') }}"></script>
    <script src="{{ url_for('static', filename='ui.js') }}"></script>
    <script src="{{ url_for('static', filename='main.js') }}"></script>
    </div>
    <script src="{{ url_for('static', filename='vendor/flowbite.min.js') }}" defer></script>
</body>
</html>
